<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CozyVerse | P2P Messenger & World</title>
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script> 
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root { --app-height: 100%; }
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; position: fixed;
            background-color: #111827;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #f3f4f6;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Mobile Controls */
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; z-index: 60; display: none; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); touch-action: none; }
        #joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; transform: translate(-50%, -50%); backdrop-filter: blur(4px); pointer-events: none; }
        #touch-look-zone { position: absolute; top: 0; right: 0; width: 50%; height: 100%; z-index: 55; touch-action: none; display: none; }

        #world-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: none; outline: none; }
        
        /* UI LAYER */
        .ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: var(--app-height);
            z-index: 10; display: flex; flex-direction: column; overflow: hidden;
        }
        
        #chat-panel { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
        #messages-container { flex: 1 1 auto; overflow-y: auto; height: 0; min-height: 0; width: 100%; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        #input-area { flex-shrink: 0; width: 100%; z-index: 40; padding-bottom: max(10px, env(safe-area-inset-bottom)); }

        .msg-row { display: flex; width: 100%; margin-bottom: 8px; }
        .msg-content { display: flex; flex-direction: column; max-width: 80%; }
        .msg-bubble { padding: 8px 12px; border-radius: 16px; font-size: 0.95rem; box-shadow: 0 1px 2px rgba(0,0,0,0.2); width: fit-content; word-break: break-word; line-height: 1.4; }
        .msg-me { justify-content: flex-end; }
        .msg-me .msg-content { align-items: flex-end; }
        .msg-me .msg-bubble { background-color: #8b5cf6; color: white; border-bottom-right-radius: 2px; }
        .msg-them { justify-content: flex-start; }
        .msg-them .msg-content { align-items: flex-start; }
        .msg-them .msg-bubble { background-color: #374151; color: white; border-bottom-left-radius: 2px; }

        .video-container { aspect-ratio: 16/9; background: black; width: 100%; border-radius: 8px; overflow: hidden; position: relative; }
        .video-container video { width: 100%; height: 100%; object-fit: contain; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #8b5cf6; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #4b5563; border-radius: 2px; }

        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s; text-align: center; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); }
        .toast.show { opacity: 1; }
        
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { cozy: { 50: '#f5f3ff', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 900: '#4c1d95' } } } }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 selection:bg-cozy-500 selection:text-white overflow-hidden fixed inset-0">

    <canvas id="world-canvas"></canvas>
    <div id="toast-container"></div>

    <!-- Setup View -->
    <div id="view-setup" class="ui-layer items-center justify-center bg-gradient-to-br from-gray-900 to-black p-4">
        <div class="glass p-6 rounded-2xl shadow-xl max-w-md w-full flex flex-col items-center space-y-6 z-20">
            <h1 class="text-3xl font-bold text-cozy-500 tracking-tight">CozyVerse</h1>
            <div id="setup-preview-container" class="w-40 h-40 bg-gray-800 rounded-full shadow-inner overflow-hidden relative border-4 border-white/10 flex items-center justify-center">
                <canvas id="preview-canvas" class="w-full h-full"></canvas>
            </div>
            <div class="w-full space-y-4">
                <input type="text" id="setup-name" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:border-cozy-500 outline-none transition text-center font-bold text-white placeholder-gray-500 z-50 relative" placeholder="Enter Display Name">
                <div class="space-y-2 bg-white/5 p-3 rounded-lg">
                    <div class="flex justify-between items-center"><span class="text-xs font-bold opacity-70">Skin</span><input type="color" id="setup-color-base" value="#ffdbac" onchange="app.updateLook('skin', this.value)" class="w-8 h-8 rounded border-none bg-transparent cursor-pointer"></div>
                    <div class="flex justify-between items-center"><span class="text-xs font-bold opacity-70">Outfit</span><input type="color" id="setup-color-outfit" value="#8b5cf6" onchange="app.updateLook('outfit', this.value)" class="w-8 h-8 rounded border-none bg-transparent cursor-pointer"></div>
                    <div class="flex justify-between items-center"><span class="text-xs font-bold opacity-70">Style</span><div class="flex items-center gap-1"><button onclick="app.changeType(-1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-left"></i></button><span id="setup-lbl-type" class="text-xs w-16 text-center font-mono">Human</span><button onclick="app.changeType(1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-right"></i></button></div></div>
                    <div class="flex justify-between items-center"><span class="text-xs font-bold opacity-70">Hat</span><div class="flex items-center gap-1"><button onclick="app.changeHat(-1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-left"></i></button><span id="setup-lbl-hat" class="text-xs w-16 text-center font-mono">None</span><button onclick="app.changeHat(1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-right"></i></button></div></div>
                    <div class="flex justify-between items-center"><span class="text-xs font-bold opacity-70">Back</span><div class="flex items-center gap-1"><button onclick="app.changeBack(-1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-left"></i></button><span id="setup-lbl-back" class="text-xs w-16 text-center font-mono">None</span><button onclick="app.changeBack(1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-right"></i></button></div></div>
                </div>
            </div>
            <button onclick="app.finishSetup()" class="w-full py-3 bg-cozy-600 hover:bg-cozy-700 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95">Enter Universe</button>
        </div>
    </div>

    <!-- Home Screen View -->
    <div id="view-home" class="ui-layer hidden flex flex-col bg-gray-900">
        <div class="p-6 flex justify-between items-center bg-gray-800 shadow-sm border-b border-gray-700">
            <h1 class="text-2xl font-bold text-cozy-500">CozyVerse</h1>
            <button onclick="app.toggleSettingsModal()" class="p-2 rounded-full hover:bg-gray-700"><i class="ph ph-gear text-xl"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="glass bg-gradient-to-br from-cozy-600 to-purple-800 rounded-2xl p-6 text-white shadow-lg animate-float relative overflow-hidden">
                <div class="absolute top-0 right-0 opacity-10 transform translate-x-8 -translate-y-8"><i class="ph ph-planet text-[120px]"></i></div>
                <div class="flex items-center gap-4 relative z-10">
                    <div id="home-avatar-preview" class="w-20 h-20 bg-white/10 rounded-full border-2 border-white/30 overflow-hidden flex items-center justify-center"></div>
                    <div>
                        <h2 id="home-welcome-name" class="text-2xl font-bold">Welcome!</h2>
                        <p class="text-sm opacity-80">Ready to explore?</p>
                    </div>
                </div>
                <div class="mt-6 bg-black/20 p-3 rounded-xl flex items-center justify-between cursor-pointer hover:bg-black/30 transition" onclick="app.copyMyId()">
                    <div class="flex flex-col overflow-hidden">
                        <span class="text-[10px] uppercase font-bold opacity-60">Your Universal ID</span>
                        <span id="home-my-id" class="font-mono text-sm truncate">Loading...</span>
                    </div>
                    <i class="ph ph-copy text-xl"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-sm flex flex-col items-center justify-center gap-1 border border-gray-700">
                    <span id="stat-contacts" class="text-2xl font-bold text-cozy-500">0</span>
                    <span class="text-xs opacity-60 uppercase font-bold">Contacts</span>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl shadow-sm flex flex-col items-center justify-center gap-1 border border-gray-700">
                    <span id="stat-groups" class="text-2xl font-bold text-purple-500">0</span>
                    <span class="text-xs opacity-60 uppercase font-bold">Groups</span>
                </div>
            </div>

            <button onclick="app.switchView('messenger')" class="w-full py-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-sm flex items-center justify-between px-6 hover:bg-gray-700 transition group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-cozy-900/50 flex items-center justify-center text-cozy-500"><i class="ph ph-chat-circle-text text-2xl"></i></div>
                    <div class="text-left">
                        <h3 class="font-bold text-lg">Messenger & Worlds</h3>
                        <p class="text-xs opacity-60">Chat and hang out with friends</p>
                    </div>
                </div>
                <i class="ph ph-caret-right text-gray-400 group-hover:text-cozy-500 group-hover:translate-x-1 transition"></i>
            </button>
        </div>
    </div>

    <!-- Messenger View -->
    <div id="view-messenger" class="ui-layer hidden flex-row bg-gray-900">
        <div class="w-full md:w-80 border-r border-gray-700 flex flex-col h-full bg-gray-800 flex-shrink-0">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <div class="flex items-center space-x-2 cursor-pointer hover:opacity-70 transition" onclick="app.goHome()">
                    <div class="w-8 h-8 rounded-lg bg-cozy-500 flex items-center justify-center text-white"><i class="ph ph-house-simple"></i></div>
                    <span class="font-bold text-sm">Home</span>
                </div>
                <button onclick="app.toggleSettingsModal()" class="p-2 rounded-full hover:bg-white/10 transition"><i class="ph ph-gear text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2">
                <!-- Groups Section -->
                <div class="flex flex-col gap-2 px-2 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold uppercase opacity-50 tracking-wider">Groups</span>
                        <button onclick="app.showCreateGroupModal()" class="text-cozy-500 hover:text-cozy-400 p-1" title="Create Group"><i class="ph ph-plus-circle text-xl"></i></button>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="join-group-input" placeholder="Paste Host ID..." class="flex-1 p-2 text-xs rounded border bg-gray-900 border-gray-700 focus:border-cozy-500 outline-none text-white">
                        <button onclick="app.joinGroupById()" class="p-2 bg-gray-700 rounded hover:bg-gray-600"><i class="ph ph-arrow-right"></i></button>
                    </div>
                    <div id="groups-list" class="space-y-1 mt-2"></div>
                </div>

                <!-- Contacts Section -->
                <div class="flex justify-between items-center px-2 mb-2">
                    <span class="text-xs font-bold uppercase opacity-50 tracking-wider">Direct Messages</span>
                </div>
                <div class="flex space-x-2 mb-2 px-2">
                    <input type="text" id="add-peer-input" placeholder="Enter Peer ID..." class="flex-1 p-2 text-xs rounded border bg-gray-900 border-gray-700 focus:border-cozy-500 outline-none text-white">
                    <button onclick="app.addContact()" class="p-2 bg-gray-700 rounded hover:bg-gray-600"><i class="ph ph-plus"></i></button>
                </div>
                <div id="contacts-list" class="space-y-1 px-2"></div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div id="chat-panel" class="hidden md:flex flex-col relative bg-gray-900 z-20">
            <div id="chat-header" class="p-3 border-b border-gray-700 flex flex-wrap gap-y-2 justify-between items-center bg-gray-900/90 backdrop-blur z-30">
                <div class="flex items-center gap-2 mr-2">
                    <button class="md:hidden p-2" onclick="app.backToContacts()"><i class="ph ph-arrow-left"></i></button>
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <h3 id="current-chat-name" class="font-bold text-lg leading-tight truncate max-w-[150px] sm:max-w-xs text-white">Select Chat</h3>
                            <div id="conn-indicator" class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0" title="Offline"></div>
                            <span id="live-badge" class="hidden px-1.5 py-0.5 rounded bg-red-500 text-white text-[10px] font-bold animate-pulse">LIVE</span>
                        </div>
                        <span id="chat-status" class="text-[10px] opacity-60">Offline</span>
                    </div>
                </div>
                
                <div id="world-actions" class="hidden flex flex-wrap gap-2 items-center justify-end flex-1">
                    <button id="btn-watch-stream" onclick="app.openStreamModal()" class="hidden px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-xs font-bold flex items-center gap-1 shadow-lg border border-purple-400">
                        <i class="ph ph-television"></i> <span class="hidden sm:inline">Watch</span>
                    </button>
                    <button onclick="app.showInviteModal()" class="p-2 text-xs bg-gray-800 rounded hover:bg-gray-700 border border-gray-600" title="Invite Contact"><i class="ph ph-user-plus"></i></button>
                    <button onclick="app.copyGroupInvite()" class="p-2 text-xs bg-gray-800 rounded hover:bg-gray-700 border border-gray-600" title="Copy Invite Link"><i class="ph ph-share-network"></i></button>
                    
                    <div id="launch-controls" class="flex gap-2 items-center">
                        <select id="world-select" class="text-xs p-2 rounded border bg-gray-800 border-gray-600 outline-none max-w-[100px] text-white">
                            <option value="cabin">Cozy Cabin</option>
                            <option value="meadow">Sunny Meadow</option>
                            <option value="neon">Neon Night</option>
                            <option value="clouds">Cloud Haven</option>
                        </select>
                        <button onclick="app.launchWorld()" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-full text-sm shadow font-semibold flex items-center gap-1 whitespace-nowrap"><i class="ph ph-globe"></i> Launch</button>
                    </div>
                </div>
                <div id="join-world-btn-container" class="hidden ml-auto">
                    <button onclick="app.joinWorld()" class="px-4 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-full text-sm shadow-lg font-bold flex items-center gap-2 animate-bounce whitespace-nowrap">
                        <i class="ph ph-rocket-launch"></i> Join World
                    </button>
                </div>
            </div>

            <div id="messages-container" class="px-4 bg-gray-900">
                <div class="text-center text-gray-500 mt-10 opacity-50 text-sm">Select a chat to start messaging.</div>
            </div>
            
            <div id="input-area" class="p-3 border-t border-gray-700 bg-gray-900 flex gap-2">
                <input type="text" id="msg-input" class="flex-1 p-3 rounded-full bg-gray-800 border border-gray-700 text-white focus:ring-2 ring-cozy-500 outline-none" placeholder="Type a message...">
                <button onclick="app.sendMessage()" class="p-3 rounded-full bg-cozy-600 text-white hover:scale-105 transition"><i class="ph ph-paper-plane-right-fill"></i></button>
            </div>
        </div>
    </div>

    <!-- Modals (Simplified for one-file readability) -->
    <div id="modal-create-group" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
            <h3 class="text-xl font-bold mb-4">Create Group</h3>
            <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-2 mb-4 rounded border bg-gray-900 border-gray-600 text-white">
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-create-group').classList.add('hidden')" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                <button onclick="app.createGroup()" class="flex-1 py-2 bg-cozy-600 text-white rounded font-bold">Create</button>
            </div>
        </div>
    </div>

    <div id="modal-invite-contact" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
            <h3 class="text-xl font-bold mb-4">Invite to Group</h3>
            <div id="invite-list" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
            <button onclick="document.getElementById('modal-invite-contact').classList.add('hidden')" class="w-full py-2 bg-gray-700 rounded">Close</button>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Settings</h3>
                <button onclick="app.toggleSettingsModal()"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div class="mb-6 bg-gray-700/50 p-4 rounded-lg">
                <h4 class="text-sm font-bold uppercase opacity-70 mb-3">Look</h4>
                <div class="flex gap-4">
                    <div id="settings-preview-container" class="w-24 h-24 bg-gray-900 rounded-full shadow-inner border border-white/10 flex-shrink-0 flex items-center justify-center overflow-hidden relative"></div>
                    <div class="flex-1 space-y-2">
                        <div class="flex justify-between items-center"><span class="text-xs">Skin</span><input type="color" id="color-base" onchange="app.updateLook('skin', this.value)" class="w-6 h-6 rounded border-none bg-transparent cursor-pointer"></div>
                        <div class="flex justify-between items-center"><span class="text-xs">Outfit</span><input type="color" id="color-outfit" onchange="app.updateLook('outfit', this.value)" class="w-6 h-6 rounded border-none bg-transparent cursor-pointer"></div>
                        <div class="flex justify-between items-center"><span class="text-xs">Style</span><div class="flex items-center gap-1"><button onclick="app.changeType(-1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-left"></i></button><span id="lbl-type" class="text-xs w-14 text-center truncate">Human</span><button onclick="app.changeType(1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-right"></i></button></div></div>
                        <div class="flex justify-between items-center"><span class="text-xs">Hat</span><div class="flex items-center gap-1"><button onclick="app.changeHat(-1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-left"></i></button><span id="lbl-hat" class="text-xs w-14 text-center truncate">None</span><button onclick="app.changeHat(1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-right"></i></button></div></div>
                        <div class="flex justify-between items-center"><span class="text-xs">Back</span><div class="flex items-center gap-1"><button onclick="app.changeBack(-1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-left"></i></button><span id="lbl-back" class="text-xs w-14 text-center truncate">None</span><button onclick="app.changeBack(1)" class="p-1 bg-white/10 rounded hover:bg-white/20"><i class="ph ph-caret-right"></i></button></div></div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4 border-t border-gray-700 pt-4">
                <div class="flex items-center justify-between"><span class="text-sm">Include Chat History</span><input type="checkbox" id="include-history-check" class="accent-cozy-500"></div>
                <div><textarea id="import-area" class="w-full text-xs p-2 mt-1 rounded bg-gray-900 border border-gray-600 h-24 font-mono text-white" placeholder="Data..."></textarea></div>
                <div class="flex gap-2">
                    <button onclick="app.exportData()" class="flex-1 py-2 bg-gray-700 text-white rounded text-sm font-bold hover:bg-gray-600">Copy</button>
                    <button onclick="app.importData()" class="flex-1 py-2 bg-cozy-600 text-white rounded text-sm font-bold hover:bg-cozy-500">Load</button>
                </div>
                <button onclick="app.resetProfile()" class="w-full py-2 border border-red-500 text-red-500 hover:bg-red-500/20 rounded font-bold text-sm transition">Reset Profile</button>
            </div>
        </div>
    </div>

    <div id="modal-join-request" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full animate-bounce-in border border-gray-600">
            <h3 class="text-xl font-bold mb-2">Join Group?</h3>
            <p class="text-sm opacity-70 mb-4">Invite from <span id="join-host-name" class="font-bold">User</span> to group: <span id="join-group-name" class="font-bold text-cozy-500">Group</span>?</p>
            <div class="flex gap-2"><button onclick="document.getElementById('modal-join-request').classList.add('hidden')" class="flex-1 py-2 bg-gray-700 rounded text-sm font-bold">Ignore</button><button onclick="app.acceptGroupInvite()" class="flex-1 py-2 bg-cozy-600 text-white rounded text-sm font-bold">Join</button></div>
        </div>
    </div>

    <div id="modal-stream" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="bg-gray-900 p-4 rounded-xl shadow-2xl max-w-4xl w-full flex flex-col gap-4 border border-gray-700">
            <div class="flex justify-between items-center text-white"><h3 class="font-bold">Broadcast</h3><button onclick="app.closeStreamModal()"><i class="ph ph-x text-xl"></i></button></div>
            <div class="video-container bg-black relative"><video id="stream-video" autoplay playsinline class="w-full h-full"></video><div class="absolute bottom-4 right-4 bg-black/50 p-2 rounded flex items-center gap-2"><button onclick="app.toggleStreamMute()" id="btn-stream-mute"><i class="ph ph-speaker-high text-white"></i></button></div></div>
        </div>
    </div>

    <!-- 3D World Overlay -->
    <div id="world-overlay" class="hidden absolute top-0 left-0 w-full h-full z-30 pointer-events-none flex flex-col justify-between">
        <div class="p-4 flex justify-between items-start pointer-events-auto">
            <div class="glass p-2 rounded-lg text-white text-xs flex flex-col gap-1 shadow-lg">
                <div class="font-bold opacity-80 flex items-center gap-2"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> World Active</div>
                <button onclick="app.shareScreen()" id="btn-share-screen" class="bg-purple-600 hover:bg-purple-500 px-2 py-1.5 rounded mt-1 font-bold">Share Screen</button>
                <button onclick="app.toggleCameraMode()" class="bg-white/10 hover:bg-white/20 px-2 py-1 rounded mt-1">Toggle Cam (C)</button>
                <div class="mt-2 text-[10px] opacity-70 md:block hidden">Click screen to lock mouse</div>
            </div>
            <button onclick="app.leaveWorld()" class="glass p-3 rounded-full text-red-400 hover:text-red-200 hover:bg-red-500/20 transition shadow-lg"><i class="ph ph-x-circle text-2xl"></i></button>
        </div>
        <div class="p-4 w-full max-w-md pointer-events-auto mb-20 md:mb-0">
            <div id="world-chat-log" class="h-40 overflow-y-auto mask-gradient mb-2 text-white text-shadow shadow-black/50 text-sm space-y-1 font-medium px-2"></div>
            <input type="text" id="world-input" class="glass w-full p-3 rounded-full text-white placeholder-white/50 outline-none focus:bg-black/60 transition" placeholder="Say something...">
        </div>
        
        <div id="mobile-ui-layer" class="absolute inset-0 z-50 md:hidden pointer-events-none">
            <div id="joystick-zone" class="pointer-events-auto"><div id="joystick-knob"></div></div>
            <div id="touch-look-zone" class="pointer-events-auto"></div>
        </div>
    </div>

    <script>
        // --- GLOBAL CONFIG & HELPERS ---
        const CONFIG = { 
            peerConfig: { debug: 1, secure: true, config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] } }, 
            HOST_ID_PREFIX: 'GROUP_' 
        };
        const showToast = (msg) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div'); toast.className = 'toast'; toast.innerText = msg;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        };
        const setAppHeight = () => document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        window.addEventListener('resize', setAppHeight); setAppHeight();

        // --- SHARED RESOURCES (Optimization) ---
        // Re-use geometries and materials to reduce GPU calls
        const SharedResources = {
            mats: {},
            geos: {},
            init: function() {
                this.mats.skin = new THREE.MeshLambertMaterial({ color: 0xffdbac, flatShading: true });
                this.mats.outfit = new THREE.MeshLambertMaterial({ color: 0x8b5cf6, flatShading: true });
                this.mats.dark = new THREE.MeshLambertMaterial({ color: 0x222222, flatShading: true });
                this.mats.white = new THREE.MeshLambertMaterial({ color: 0xffffff, flatShading: true });
                this.geos.box = new THREE.BoxGeometry(1,1,1);
                this.geos.sphere = new THREE.SphereGeometry(1, 8, 8);
            },
            getMat: function(type, colorStr) {
                if(!colorStr) return this.mats[type];
                const key = type + '_' + colorStr;
                if(!this.mats[key]) {
                    this.mats[key] = new THREE.MeshLambertMaterial({ color: new THREE.Color(colorStr), flatShading: true });
                }
                return this.mats[key];
            }
        };

        // --- AVATAR ENGINE ---
        class Avatar {
            static create(data) {
                const group = new THREE.Group();
                const skinMat = SharedResources.getMat('skin', data.skinColor);
                const outfitMat = SharedResources.getMat('outfit', data.outfitColor);
                const darkMat = SharedResources.mats.dark;

                // Body
                const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.35, 0.55, 6), outfitMat);
                torso.position.y = 0.55; torso.castShadow = true; group.add(torso);
                
                // Head
                let head;
                if (data.type === 1) head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.35, 0.4), skinMat);
                else head = new THREE.Mesh(new THREE.DodecahedronGeometry(0.3, 0), skinMat);
                head.position.y = 1.05; head.castShadow = true; group.add(head);

                // Eyes (Simple)
                const eyeL = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.06, 0.05), darkMat); eyeL.position.set(-0.12, 1.05, 0.25);
                const eyeR = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.06, 0.05), darkMat); eyeR.position.set(0.12, 1.05, 0.25);
                group.add(eyeL, eyeR);

                // Limbs
                const limbGeo = new THREE.BoxGeometry(0.1, 0.35, 0.1);
                const armL_P = new THREE.Group(); armL_P.position.set(-0.32, 0.75, 0);
                const armR_P = new THREE.Group(); armR_P.position.set(0.32, 0.75, 0);
                const armL = new THREE.Mesh(limbGeo, outfitMat); armL.position.y = -0.15;
                const armR = new THREE.Mesh(limbGeo, outfitMat); armR.position.y = -0.15;
                armL_P.add(armL); armR_P.add(armR); group.add(armL_P, armR_P);

                const legL_P = new THREE.Group(); legL_P.position.set(-0.12, 0.3, 0);
                const legR_P = new THREE.Group(); legR_P.position.set(0.12, 0.3, 0);
                const legL = new THREE.Mesh(limbGeo, darkMat); legL.position.y = -0.15;
                const legR = new THREE.Mesh(limbGeo, darkMat); legR.position.y = -0.15;
                legL_P.add(legL); legR_P.add(legR); group.add(legL_P, legR_P);

                // HAT LOGIC
                if(data.hat === 1) { // Wizard
                    const cone = new THREE.Mesh(new THREE.ConeGeometry(0.25,0.5,8), darkMat); cone.position.y = 1.4;
                    const brim = new THREE.Mesh(new THREE.CylinderGeometry(0.45,0.45,0.05,8), darkMat); brim.position.y = 1.25;
                    group.add(cone, brim);
                }

                group.userData.limbs = { armL: armL_P, armR: armR_P, legL: legL_P, legR: legR_P };
                return group;
            }
        }

        // --- 3D ENGINE ---
        class Engine {
            constructor() {
                SharedResources.init();
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('world-canvas'), antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;

                // Preview setup
                this.previewRenderer = new THREE.WebGLRenderer({ canvas: document.getElementById('preview-canvas'), alpha: true, antialias: true });
                this.previewRenderer.setSize(160, 160);
                this.previewScene = new THREE.Scene();
                this.previewCamera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
                this.previewCamera.position.set(0, 0.9, 3.0); this.previewCamera.lookAt(0, 0.8, 0);
                const pl = new THREE.DirectionalLight(0xffffff, 1.2); pl.position.set(1,2,3); this.previewScene.add(pl, new THREE.AmbientLight(0xffffff, 0.5));

                this.avatars = {}; 
                this.myAvatar = null;
                this.isWorldActive = false;
                this.camMode = 0;
                this.keys = {}; this.mobileInput = {x:0, y:0};
                this.euler = new THREE.Euler(0, 0, 0, 'YXZ');
                this.clock = new THREE.Clock();

                this.initLights();
                this.setupInput();
                this.loop();
            }

            initLights() {
                const amb = new THREE.AmbientLight(0xffffff, 0.6); this.scene.add(amb);
                const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(20, 30, 10); 
                dir.castShadow = true; dir.shadow.mapSize.width = 1024;
                this.scene.add(dir);
            }

            updatePreview(d) {
                // Remove old avatar mesh
                this.previewScene.children.forEach(c => { if(c.type === 'Group') this.previewScene.remove(c); });
                const mesh = Avatar.create(d);
                this.previewScene.add(mesh);
            }

            createWorld(t) {
                // Clear old world meshes (except lights/avatars)
                this.scene.children = this.scene.children.filter(c => c.isLight || (c.userData && c.userData.isAvatar));
                
                let gc = 0x5D9C59, bg = 0x87CEEB;
                if(type === 'neon') { gc = 0x110011; bg = 0x000000; }
                this.renderer.setClearColor(bg);
                this.scene.fog = new THREE.Fog(bg, 10, 60);

                const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshLambertMaterial({ color: gc }));
                floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; floor.position.y = 0;
                this.scene.add(floor);

                if(type === 'neon') {
                    const grid = new THREE.GridHelper(200, 50, 0xff00ff, 0x220022);
                    grid.position.y = 0.05; this.scene.add(grid);
                } else if (type === 'cabin') {
                   // Simple cabin
                   const wallMat = new THREE.MeshLambertMaterial({color: 0x8d6e63});
                   const wall = new THREE.Mesh(new THREE.BoxGeometry(10,5,1), wallMat); wall.position.set(0,2.5,-5); this.scene.add(wall);
                }

                // Screen
                this.screenMesh = new THREE.Mesh(new THREE.PlaneGeometry(16, 9), new THREE.MeshBasicMaterial({ color: 0x000000 }));
                this.screenMesh.position.set(0, 6, -12); this.scene.add(this.screenMesh);
            }

            spawnMe(user) {
                if(this.myAvatar) this.scene.remove(this.myAvatar);
                this.myAvatar = Avatar.create(user);
                this.myAvatar.userData.isAvatar = true;
                this.scene.add(this.myAvatar);
            }

            // --- KEY FIX: ROBUST UPDATE PEER ---
            updatePeer(id, data) {
                if (!this.avatars[id]) {
                    // Try to find profile in user cache (populated by profile events)
                    let profile = window.app.peerProfiles[id];
                    
                    // Fallback: If no profile yet, create a placeholder (Gray Robot)
                    // This ensures visibility even if profile packet is delayed
                    if (!profile) {
                         profile = { skinColor: '#888888', outfitColor: '#aaaaaa', type: 1, hat: 0 };
                         // console.warn("Spawned placeholder for", id);
                    }

                    const mesh = Avatar.create(profile);
                    mesh.userData.isAvatar = true;
                    this.scene.add(mesh);
                    this.avatars[id] = mesh;
                }

                const av = this.avatars[id];
                // Only update target pos if data contains position
                if (data.x !== undefined) {
                    av.userData.targetPos = new THREE.Vector3(data.x, data.y, data.z);
                    av.userData.targetRot = data.ry;
                }
                // Update look if profile changed
                if (data.skinColor) {
                    this.scene.remove(av);
                    const newMesh = Avatar.create(data);
                    newMesh.userData = av.userData; // Keep pos data
                    newMesh.userData.isAvatar = true;
                    newMesh.position.copy(av.position);
                    this.scene.add(newMesh);
                    this.avatars[id] = newMesh;
                }
            }

            removePeerAvatar(id) {
                if (this.avatars[id]) {
                    this.scene.remove(this.avatars[id]);
                    delete this.avatars[id];
                }
            }

            applyVideoTexture(stream) {
                if(this.screenMesh) {
                    const video = document.createElement('video');
                    video.srcObject = stream; video.muted = true; video.play();
                    this.screenMesh.material = new THREE.MeshBasicMaterial({ map: new THREE.VideoTexture(video) });
                }
            }

            handleIncomingStream(stream, id) {
                const video = document.getElementById('stream-video');
                video.srcObject = stream;
                if (id !== this.myId) { video.muted = false; video.play(); }
                document.getElementById('btn-watch-stream').classList.remove('hidden');
                this.applyVideoTexture(stream);
            }

            setupInput() {
                // Resize
                window.addEventListener('resize', () => { 
                    this.camera.aspect = window.innerWidth/window.innerHeight; this.camera.updateProjectionMatrix(); 
                    this.renderer.setSize(window.innerWidth, window.innerHeight); 
                });

                // Keyboard
                document.addEventListener('keydown', e => { if(document.activeElement === document.body) this.keys[e.key.toLowerCase()] = true; if(e.key.toLowerCase()==='c') this.toggleCamera(); });
                document.addEventListener('keyup', e => this.keys[e.key.toLowerCase()] = false);

                // Touch
                const jZone = document.getElementById('joystick-zone');
                const jKnob = document.getElementById('joystick-knob');
                let jId = null, startX=0, startY=0;

                // Simple Joystick Logic
                jZone.addEventListener('touchstart', e => { e.preventDefault(); const t = e.changedTouches[0]; jId = t.identifier; startX = t.clientX; startY = t.clientY; });
                jZone.addEventListener('touchmove', e => {
                    e.preventDefault(); const t = [...e.changedTouches].find(x=>x.identifier===jId);
                    if(t) {
                        let dx = t.clientX - startX, dy = t.clientY - startY;
                        const dist = Math.min(35, Math.hypot(dx, dy));
                        const angle = Math.atan2(dy, dx);
                        dx = Math.cos(angle) * dist; dy = Math.sin(angle) * dist;
                        jKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                        this.mobileInput.x = dx/35; this.mobileInput.y = dy/35;
                    }
                });
                const resetJ = () => { jId=null; jKnob.style.transform = `translate(-50%, -50%)`; this.mobileInput = {x:0, y:0}; };
                jZone.addEventListener('touchend', resetJ);
                
                // Touch Look
                const lZone = document.getElementById('touch-look-zone');
                let lLastX=0, lLastY=0;
                lZone.addEventListener('touchstart', e=> { lLastX=e.changedTouches[0].clientX; lLastY=e.changedTouches[0].clientY; });
                lZone.addEventListener('touchmove', e=> {
                    const t=e.changedTouches[0]; 
                    const dx = t.clientX - lLastX; const dy = t.clientY - lLastY;
                    lLastX=t.clientX; lLastY=t.clientY;
                    this.euler.y -= dx*0.005; this.euler.x -= dy*0.005;
                    this.euler.x = Math.max(-1.5, Math.min(1.5, this.euler.x));
                    if(this.camMode===1) { this.camera.quaternion.setFromEuler(this.euler); if(this.myAvatar) this.myAvatar.rotation.y = this.euler.y; }
                    else if(this.myAvatar) this.myAvatar.rotation.y -= dx*0.005;
                });

                // Mouse Lock
                const c = document.getElementById('world-canvas');
                c.addEventListener('click', () => { if(this.camMode===1) c.requestPointerLock(); });
                document.addEventListener('mousemove', e => {
                    if(document.pointerLockElement === c && this.camMode===1) {
                        this.euler.y -= e.movementX*0.002; this.euler.x -= e.movementY*0.002;
                        this.euler.x = Math.max(-1.5, Math.min(1.5, this.euler.x));
                        this.camera.quaternion.setFromEuler(this.euler);
                        if(this.myAvatar) this.myAvatar.rotation.y = this.euler.y;
                    }
                });
            }

            toggleCamera() {
                this.camMode = (this.camMode+1)%2;
                if(this.camMode===1) { 
                    this.euler.set(0, this.myAvatar ? this.myAvatar.rotation.y : 0, 0, 'YXZ');
                    this.camera.quaternion.setFromEuler(this.euler);
                    if(!('ontouchstart' in window)) document.getElementById('world-canvas').requestPointerLock();
                } else document.exitPointerLock();
            }

            loop() {
                requestAnimationFrame(() => this.loop());
                
                // Optimization: Don't render if tab hidden or world closed
                if(document.hidden) return;

                // Preview rotation
                if(this.previewScene.children.length > 2) this.previewScene.children[this.previewScene.children.length-1].rotation.y += 0.01;
                this.previewRenderer.render(this.previewScene, this.previewCamera);

                if(!this.isWorldActive || !this.myAvatar) return;

                const dt = Math.min(this.clock.getDelta(), 0.1); // Cap dt

                // Movement
                const speed = 8.0 * dt;
                let dx=0, dz=0;
                if(this.keys['w'] || this.keys['arrowup']) dz = -1;
                if(this.keys['s'] || this.keys['arrowdown']) dz = 1;
                if(this.keys['a'] || this.keys['arrowleft']) dx = -1;
                if(this.keys['d'] || this.keys['arrowright']) dx = 1;
                if(this.mobileInput.x !== 0) dx = this.mobileInput.x;
                if(this.mobileInput.y !== 0) dz = this.mobileInput.y;

                const vec = new THREE.Vector3(dx, 0, dz);
                if(vec.lengthSq() > 0) {
                    vec.normalize().multiplyScalar(speed);
                    if(this.camMode===1) vec.applyEuler(new THREE.Euler(0, this.euler.y, 0));
                    else this.myAvatar.rotation.y = Math.atan2(vec.x, vec.z);
                    
                    this.myAvatar.position.add(vec);
                    
                    // Animation (Walking bob)
                    const s = Math.sin(Date.now() * 0.015) * 0.6;
                    const l = this.myAvatar.userData.limbs;
                    if(l) { l.armL.rotation.x = s; l.armR.rotation.x = -s; l.legL.rotation.x = -s; l.legR.rotation.x = s; }

                    // Send Position (SenderId included implicitly by App wrapper or explicitly here)
                    window.app.broadcastPosition({ 
                        x: this.myAvatar.position.x, y: this.myAvatar.position.y, z: this.myAvatar.position.z, 
                        ry: this.myAvatar.rotation.y 
                    });
                } else {
                    // Reset limbs
                    const l = this.myAvatar.userData.limbs;
                    if(l) { l.armL.rotation.x = l.armR.rotation.x = l.legL.rotation.x = l.legR.rotation.x = 0; }
                }

                // Interpolate Peers
                const lerp = 1.0 - Math.pow(0.001, dt);
                for(const id in this.avatars) {
                    const av = this.avatars[id];
                    if(av.userData.targetPos) {
                        av.position.lerp(av.userData.targetPos, lerp);
                        // Shortest path rotation
                        let d = av.userData.targetRot - av.rotation.y;
                        while(d > Math.PI) d -= Math.PI*2; while(d < -Math.PI) d += Math.PI*2;
                        av.rotation.y += d * lerp;
                        
                        // Simple walk anim for peers
                        if(av.position.distanceTo(av.userData.targetPos) > 0.1) {
                             const s = Math.sin(Date.now() * 0.015) * 0.6;
                             const l = av.userData.limbs;
                             if(l) { l.armL.rotation.x = s; l.armR.rotation.x = -s; l.legL.rotation.x = -s; l.legR.rotation.x = s; }
                        }
                    }
                }

                // Camera Follow
                if(this.camMode === 0) {
                    const target = this.myAvatar.position.clone().add(new THREE.Vector3(0, 5, 8));
                    this.camera.position.lerp(target, 0.1);
                    this.camera.lookAt(this.myAvatar.position);
                } else {
                    this.camera.position.copy(this.myAvatar.position).add(new THREE.Vector3(0,1.3,0));
                }

                this.renderer.render(this.scene, this.camera);
            }
        }

        // --- MAIN APPLICATION LOGIC ---
        class App {
            constructor() {
                this.state = {
                    user: JSON.parse(localStorage.getItem('cozyUser')) || { name: '', skinColor: '#ffdbac', outfitColor: '#8b5cf6', type: 0, hat: 0 },
                    contacts: JSON.parse(localStorage.getItem('cozyContacts')) || [],
                    groups: JSON.parse(localStorage.getItem('cozyGroups')) || [],
                    chats: JSON.parse(localStorage.getItem('cozyChats')) || {},
                    activeChatId: null, isHosting: false, activeWorldHostId: null, activeWorldUsers: {}
                };
                this.peerProfiles = {}; // Cache for profiles of people we aren't directly connected to
                this.peer = null; this.conns = {}; 
                this.engine = new Engine();
                this.lastPosTime = 0;
                this.init();
            }

            init() {
                this.updateLook();
                if(this.state.user.name) { this.goHome(); this.initPeer(); } 
                else this.switchView('setup');
                document.getElementById('setup-name').addEventListener('keypress', e => { if(e.key==='Enter') this.finishSetup(); });
                document.getElementById('msg-input').addEventListener('keypress', e => { if(e.key==='Enter') this.sendMessage(); });
                document.getElementById('join-group-input').addEventListener('keypress', e => { if(e.key==='Enter') this.joinGroupById(); });
                
                // Wake Lock
                if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
            }

            // --- LOOK & FEEL ---
            updateLook(k, v) {
                if(k==='skin') this.state.user.skinColor = v;
                if(k==='outfit') this.state.user.outfitColor = v;
                this.engine.updatePreview(this.state.user);
                // Propagate changes if online
                if(this.myId) this.broadcastProfile();
            }
            changeType(d) { this.state.user.type = this.state.user.type===1?0:1; this.updateLook(); }
            changeHat(d) { this.state.user.hat = (this.state.user.hat+d+10)%10; this.updateLook(); } // 10 hats assumed
            changeBack(d) { this.state.user.back = (this.state.user.back+d+4)%4; this.updateLook(); }

            finishSetup() {
                const n = document.getElementById('setup-name').value.trim();
                if(!n) return showToast("Name required!");
                this.state.user.name = n;
                localStorage.setItem('cozyUser', JSON.stringify(this.state.user));
                this.goHome(); this.initPeer();
            }

            // --- NAVIGATION ---
            switchView(v) {
                document.querySelectorAll('.ui-layer').forEach(e => e.classList.add('hidden'));
                document.getElementById('view-'+v).classList.remove('hidden');
                
                // Canvas juggling for preview
                const c = document.getElementById('preview-canvas');
                const t = v==='setup' ? 'setup-preview-container' : (v==='home'?'home-avatar-preview':'settings-preview-container');
                const el = document.getElementById(t);
                if(el) el.appendChild(c);

                if(v==='messenger') { this.renderGroups(); this.renderContacts(); }
            }
            goHome() {
                this.switchView('home');
                document.getElementById('home-welcome-name').innerText = `Hi, ${this.state.user.name}!`;
                document.getElementById('stat-contacts').innerText = this.state.contacts.length;
                document.getElementById('stat-groups').innerText = this.state.groups.length;
            }
            toggleSettingsModal() { 
                const modal = document.getElementById('settings-modal');
                modal.classList.toggle('hidden'); 
                this.updateCustomizationLabels(); 
                
                const isOpen = !modal.classList.contains('hidden');
                if (isOpen) {
                    // Move canvas to settings
                    const dest = document.getElementById('settings-preview-container');
                    const canvas = document.getElementById('preview-canvas');
                    if (dest && canvas) dest.appendChild(canvas);
                } else {
                    // Move canvas back to Home or Setup
                    const canvas = document.getElementById('preview-canvas');
                    const isHome = !document.getElementById('view-home').classList.contains('hidden');
                    const destId = isHome ? 'home-avatar-preview' : 'setup-preview-container';
                    const dest = document.getElementById(destId);
                    if (dest && canvas) dest.appendChild(canvas);
                }
            }

            updateCustomizationLabels() {
                const typeNames = {0:'Human', 1:'Robot'};
                const hatNames = {0:'None', 1:'Wizard', 2:'Helmet', 3:'Cowboy', 4:'Viking', 5:'Top Hat', 6:'Cap', 7:'Crown', 8:'Phones', 9:'Cat Ears'};
                const backNames = {0:'None', 1:'Cape', 2:'Wings', 3:'Jetpack'};
                const ids = ['setup-lbl', 'lbl']; 
                ids.forEach(prefix => {
                    const t = document.getElementById(prefix+'-type'); if(t) t.innerText=typeNames[this.state.user.type];
                    const h = document.getElementById(prefix+'-hat'); if(h) h.innerText=hatNames[this.state.user.hat];
                    const b = document.getElementById(prefix+'-back'); if(b) b.innerText=backNames[this.state.user.back||0];
                });
            }

            // --- NETWORKING CORE ---
            initPeer() {
                let id = localStorage.getItem('cozy_peer_id') || crypto.randomUUID();
                localStorage.setItem('cozy_peer_id', id);
                this.myId = id;
                
                this.peer = new Peer(this.myId, CONFIG.peerConfig);
                this.peer.on('open', id => {
                    this.myId = id; 
                    document.getElementById('home-my-id').innerText = id;
                    showToast("Online");
                    this.reconnect();
                });
                this.peer.on('connection', c => this.handleConn(c));
                this.peer.on('call', call => { 
                    call.answer(); 
                    call.on('stream', s => this.engine.handleIncomingStream(s, call.peer)); 
                });
                this.peer.on('error', e => console.log(e));
            }

            reconnect() {
                this.state.contacts.forEach(c => { if(!this.conns[c.id]) this.connect(c.id); });
            }
            connect(id) {
                if(id === this.myId || this.conns[id]) return;
                const conn = this.peer.connect(id);
                this.handleConn(conn);
            }
            handleConn(conn) {
                this.conns[conn.peer] = conn;
                conn.on('open', () => {
                    // Send handshake with IS_HOST flag if applicable
                    const isGroupHost = this.state.groups.some(g => g.id === this.state.activeChatId && g.hostId === this.myId);
                    conn.send({ 
                        type: 'handshake', 
                        user: this.state.user, 
                        senderId: this.myId,
                        isWorldHost: this.state.isHosting && this.engine.isWorldActive
                    });
                    this.updateConnUI(conn.peer, true);
                });
                conn.on('data', d => this.handleData(conn.peer, d));
                conn.on('close', () => {
                    delete this.conns[conn.peer];
                    this.engine.removePeerAvatar(conn.peer);
                    this.updateConnUI(conn.peer, false);
                    if(this.state.activeWorldHostId === conn.peer) {
                        this.leaveWorld(); showToast("Host Disconnected");
                    }
                    if(this.state.isHosting) {
                        delete this.state.activeWorldUsers[conn.peer];
                        this.broadcastWorldState();
                    }
                });
            }

            // --- DATA HANDLER (The Brain) ---
            handleData(peerId, data) {
                // IMPORTANT: Use the explicit senderId from the packet, fallback to connection peerId
                const sourceId = data.senderId || peerId;

                switch(data.type) {
                    case 'handshake':
                        this.peerProfiles[sourceId] = data.user;
                        // Auto-add if not in contacts (Fixes re-adding logic)
                        if(!this.state.contacts.find(x => x.id === sourceId)) {
                            this.state.contacts.push({id: sourceId, name: data.user.name});
                            localStorage.setItem('cozyContacts', JSON.stringify(this.state.contacts));
                            this.renderContacts();
                        } else {
                            const c = this.state.contacts.find(x=>x.id===sourceId);
                            if(c && c.name === 'Unknown') { c.name = data.user.name; this.renderContacts(); }
                        }
                        
                        if(data.isWorldHost) { 
                            this.state.activeWorldHostId = sourceId;
                            this.updateWorldUI();
                        }
                        break;
                    
                    case 'chat':
                        this.addMessage(data.groupId || peerId, data.msg, false, data.senderName, data.ts);
                        if(this.state.isHosting) this.broadcast(data, peerId); // Relay chat
                        break;

                    case 'pos':
                        if(this.state.isHosting) {
                            this.state.activeWorldUsers[sourceId] = { ...this.state.activeWorldUsers[sourceId], ...data, id: sourceId };
                            this.broadcast(data, peerId); 
                        }
                        this.engine.updatePeer(sourceId, data);
                        break;

                    case 'profile':
                        this.peerProfiles[sourceId] = data.user;
                        this.engine.updatePeer(sourceId, data.user); // Redraw
                        if(this.state.isHosting) this.broadcast(data, peerId);
                        break;

                    case 'world-state':
                        if(data.users) {
                            Object.keys(data.users).forEach(uid => {
                                if(uid !== this.myId) {
                                    this.peerProfiles[uid] = data.users[uid]; // Update cache
                                    this.engine.updatePeer(uid, data.users[uid]);
                                }
                            });
                        }
                        if(!this.engine.isWorldActive && data.worldType) {
                            this.pendingWorldType = data.worldType;
                            showToast("World Active");
                            this.updateWorldUI();
                        }
                        break;

                    case 'world-enter':
                        if(this.state.isHosting) {
                            this.state.activeWorldUsers[sourceId] = { ...data.user, id: sourceId };
                            this.broadcastWorldState(); 
                            this.broadcast({ type: 'profile', user: data.user, senderId: sourceId });
                        }
                        break;

                    case 'group-invite':
                        if(confirm(`Join group "${data.groupName}"?`)) {
                            if(!this.state.groups.find(g=>g.id===data.groupId)) {
                                this.state.groups.push({id: data.groupId, name: data.groupName, hostId: sourceId});
                                localStorage.setItem('cozyGroups', JSON.stringify(this.state.groups));
                                this.renderGroups();
                            }
                            this.openChat(data.groupId);
                        }
                        break;
                }
            }

            broadcast(data, excludeId) {
                Object.values(this.conns).forEach(c => {
                    if(c.peer !== excludeId && c.open) c.send(data);
                });
            }

            broadcastPosition(pos) {
                const now = Date.now();
                if(now - this.lastPosTime < 80) return; 
                this.lastPosTime = now;

                const packet = { type: 'pos', ...pos, senderId: this.myId };
                
                if(this.state.isHosting) {
                    this.state.activeWorldUsers[this.myId] = { ...this.state.user, ...pos, id: this.myId };
                    this.broadcast(packet); 
                } else {
                    Object.values(this.conns).forEach(c => c.open && c.send(packet));
                }
            }

            broadcastProfile() {
                this.state.user.id = this.myId; 
                const packet = { type: 'profile', user: this.state.user, senderId: this.myId };
                if(this.state.isHosting) this.broadcast(packet);
                else Object.values(this.conns).forEach(c => c.open && c.send(packet));
            }

            broadcastWorldState() {
                const users = { ...this.state.activeWorldUsers };
                if(this.engine.myAvatar) {
                    users[this.myId] = { ...this.state.user, 
                        x: this.engine.myAvatar.position.x, y: this.engine.myAvatar.position.y, z: this.engine.myAvatar.position.z,
                        ry: this.engine.myAvatar.rotation.y, id: this.myId 
                    };
                }
                this.broadcast({ type: 'world-state', users, worldType: this.pendingWorldType, senderId: this.myId });
            }

            launchWorld() {
                const t = document.getElementById('world-select').value;
                this.pendingWorldType = t;
                this.state.activeWorldHostId = this.myId;
                this.state.activeWorldUsers = {}; // Reset
                
                this.enterWorld(t);
                this.state.isHosting = true; // Flag enabled
                
                this.broadcast({ type: 'world-state', worldType: t, users: {}, senderId: this.myId });
                this.updateWorldUI();
            }

            joinWorld() {
                if(!this.pendingWorldType) return;
                this.enterWorld(this.pendingWorldType);
                if(this.state.activeWorldHostId && this.conns[this.state.activeWorldHostId]) {
                    this.conns[this.state.activeWorldHostId].send({ type: 'world-enter', user: this.state.user, senderId: this.myId });
                }
            }

            enterWorld(type) {
                document.getElementById('world-canvas').style.display='block';
                document.getElementById('world-overlay').classList.remove('hidden');
                document.getElementById('view-messenger').classList.add('hidden');
                
                if(window.matchMedia("(max-width: 768px)").matches) {
                    document.getElementById('joystick-zone').style.display='block';
                    document.getElementById('touch-look-zone').style.display='block';
                }

                this.engine.isWorldActive = true;
                this.engine.createWorld(type);
                this.engine.spawnMe(this.state.user);
            }

            leaveWorld() {
                document.getElementById('world-canvas').style.display='none';
                document.getElementById('world-overlay').classList.add('hidden');
                document.getElementById('joystick-zone').style.display='none';
                document.getElementById('touch-look-zone').style.display='none';
                document.getElementById('view-messenger').classList.remove('hidden');
                
                this.engine.isWorldActive = false;
                this.state.isHosting = false;
            }

            updateWorldUI() {
                const isLive = !!this.state.activeWorldHostId;
                const isMe = this.state.activeWorldHostId === this.myId;
                document.getElementById('live-badge').classList.toggle('hidden', !isLive);
                document.getElementById('launch-controls').classList.toggle('hidden', isLive && !isMe);
                document.getElementById('join-world-btn-container').classList.toggle('hidden', !isLive || isMe);
            }

            sendMessage() {
                const txt = document.getElementById('msg-input').value.trim();
                if(!txt || !this.state.activeChatId) return;
                
                // Check connection status before sending
                let targetId = this.state.activeChatId;
                if (!targetId.startsWith(CONFIG.HOST_ID_PREFIX) && (!this.conns[targetId] || !this.conns[targetId].open)) {
                    showToast("Reconnecting...");
                    this.connect(targetId);
                    // Don't return, try to send anyway, it might queue or fail gracefully, but at least we initiated reconnect
                }

                const ts = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                this.addMessage(this.state.activeChatId, txt, true, this.state.user.name, ts);
                
                const packet = { type: 'chat', msg: txt, senderName: this.state.user.name, ts, groupId: this.state.activeChatId, senderId: this.myId };
                
                if(this.state.activeChatId.startsWith(CONFIG.HOST_ID_PREFIX)) {
                    if(this.state.isHosting) this.broadcast(packet);
                    else {
                        const g = this.state.groups.find(x=>x.id===this.state.activeChatId);
                        if(g && this.conns[g.hostId]) this.conns[g.hostId].send(packet);
                    }
                } else {
                    if(this.conns[this.state.activeChatId]) this.conns[this.state.activeChatId].send(packet);
                }
                document.getElementById('msg-input').value = '';
            }

            addMessage(chatId, txt, isMe, name, ts) {
                if(!this.state.chats[chatId]) this.state.chats[chatId] = [];
                this.state.chats[chatId].push({txt, isMe, name, ts});
                localStorage.setItem('cozyChats', JSON.stringify(this.state.chats));
                if(this.state.activeChatId === chatId) this.renderMessages(chatId);
                if(this.engine.isWorldActive) {
                    const l = document.getElementById('world-chat-log');
                    const d = document.createElement('div'); d.innerHTML = `<span class="opacity-60 text-xs">${name}:</span> ${txt}`;
                    l.appendChild(d); l.scrollTop = l.scrollHeight;
                }
            }

            renderMessages(id) {
                const c = document.getElementById('messages-container'); c.innerHTML = '';
                const msgs = this.state.chats[id] || [];
                msgs.forEach(m => {
                    const d = document.createElement('div');
                    d.className = `msg-row ${m.isMe?'msg-me':'msg-them'}`;
                    d.innerHTML = `<div class="msg-content"><div class="text-[10px] opacity-50 px-1 mb-0.5">${m.name}  ${m.ts}</div><div class="msg-bubble">${m.txt}</div></div>`;
                    c.appendChild(d);
                });
                requestAnimationFrame(() => c.scrollTop = c.scrollHeight);
            }

            createGroup() {
                const name = document.getElementById('new-group-name').value;
                if(!name) return;
                const gid = CONFIG.HOST_ID_PREFIX + Math.random().toString(36).substr(2,9);
                this.state.groups.push({ id: gid, name, hostId: this.myId });
                localStorage.setItem('cozyGroups', JSON.stringify(this.state.groups));
                this.renderGroups();
                document.getElementById('modal-create-group').classList.add('hidden');
                this.openChat(gid);
            }
            addContact(val) {
                const id = val || document.getElementById('add-peer-input').value;
                if(id && id !== this.myId) {
                    // Add to local state if new
                    if (!this.state.contacts.find(c=>c.id===id)) {
                        this.state.contacts.push({id, name: 'Unknown'});
                        localStorage.setItem('cozyContacts', JSON.stringify(this.state.contacts));
                        this.renderContacts();
                    }
                    
                    // Check if connection exists but maybe needs a nudge
                    if(this.conns[id] && this.conns[id].open) {
                        // Force handshake to re-announce presence
                        this.conns[id].send({ type: 'handshake', user: this.state.user, senderId: this.myId });
                        this.openChat(id);
                    } else {
                        this.connect(id);
                    }
                }
            }
            deleteContact(id) {
                if(confirm("Delete contact?")) {
                    this.state.contacts = this.state.contacts.filter(c => c.id !== id);
                    localStorage.setItem('cozyContacts', JSON.stringify(this.state.contacts));
                    // Close actual connection so re-adding works cleanly
                    if(this.conns[id]) {
                        this.conns[id].close();
                        delete this.conns[id];
                    }
                    this.renderContacts();
                    if(this.state.activeChatId === id) this.backToContacts();
                }
            }
            openChat(id) {
                this.state.activeChatId = id;
                document.getElementById('chat-panel').classList.remove('hidden');
                if(window.innerWidth < 768) document.querySelector('#view-messenger > div:first-child').classList.add('hidden');
                
                const isGroup = id.startsWith(CONFIG.HOST_ID_PREFIX);
                if(isGroup) {
                    const g = this.state.groups.find(x=>x.id===id);
                    document.getElementById('current-chat-name').innerText = g ? g.name : 'Group';
                    this.state.isHosting = (g && g.hostId === this.myId);
                    this.state.activeWorldHostId = g ? g.hostId : null;
                    document.getElementById('world-actions').classList.remove('hidden');
                } else {
                    const c = this.state.contacts.find(x=>x.id===id);
                    document.getElementById('current-chat-name').innerText = c ? c.name : 'Direct';
                    document.getElementById('world-actions').classList.add('hidden');
                    this.state.isHosting = false;
                }
                this.updateConnUI(id, this.conns[id] && this.conns[id].open);
                this.renderMessages(id);
                this.updateWorldUI();
            }
            
            backToContacts() { document.getElementById('chat-panel').classList.add('hidden'); document.querySelector('#view-messenger > div:first-child').classList.remove('hidden'); }
            
            renderGroups() {
                const l = document.getElementById('groups-list'); l.innerHTML = '';
                this.state.groups.forEach(g => {
                    const d = document.createElement('div');
                    d.className = `p-2 rounded flex items-center justify-between text-sm hover:bg-gray-700 cursor-pointer text-white ${this.state.activeChatId===g.id?'bg-gray-700 font-bold':''}`;
                    d.onclick = () => this.openChat(g.id);
                    d.innerHTML = `<span>${g.name}</span><button class="text-gray-500 hover:text-red-500" onclick="event.stopPropagation(); app.deleteGroup('${g.id}')"><i class="ph ph-trash"></i></button>`;
                    l.appendChild(d);
                });
            }
            renderContacts() {
                const l = document.getElementById('contacts-list'); l.innerHTML = '';
                this.state.contacts.forEach(c => {
                    const d = document.createElement('div');
                    d.className = `p-2 rounded flex items-center justify-between text-sm hover:bg-gray-700 cursor-pointer text-white ${this.state.activeChatId===c.id?'bg-gray-700 font-bold':''}`;
                    d.onclick = () => this.openChat(c.id);
                    d.innerHTML = `
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="truncate">${c.name}</span>
                            <span class="w-2 h-2 rounded-full ${this.conns[c.id]?'bg-green-500':'bg-gray-600'} flex-shrink-0"></span>
                        </div>
                        <button class="text-gray-500 hover:text-red-500 p-1" onclick="event.stopPropagation(); app.deleteContact('${c.id}')"><i class="ph ph-trash"></i></button>
                    `;
                    l.appendChild(d);
                });
            }
            updateConnUI(id, isOpen) {
                if(this.state.activeChatId !== id) return;
                document.getElementById('conn-indicator').className = `w-2 h-2 rounded-full ${isOpen?'bg-green-500':'bg-red-500'} flex-shrink-0`;
                document.getElementById('chat-status').innerText = isOpen ? "Online" : "Offline";
            }
            
            showCreateGroupModal() { document.getElementById('modal-create-group').classList.remove('hidden'); }
            deleteGroup(id) {
                if(confirm("Delete group?")) {
                    this.state.groups = this.state.groups.filter(g=>g.id!==id);
                    localStorage.setItem('cozyGroups', JSON.stringify(this.state.groups));
                    this.renderGroups();
                    if(this.state.activeChatId===id) this.backToContacts();
                }
            }
            copyMyId() { navigator.clipboard.writeText(this.myId); showToast("ID Copied"); }
            copyGroupInvite() { navigator.clipboard.writeText(this.myId); showToast("Host ID Copied"); }
            showInviteModal() {
                const l = document.getElementById('invite-list'); l.innerHTML = '';
                this.state.contacts.forEach(c => {
                    const b = document.createElement('button');
                    b.className = "w-full p-2 text-left hover:bg-gray-700 rounded text-white flex justify-between";
                    b.innerHTML = `<span>${c.name}</span>`;
                    b.onclick = () => {
                        if(this.conns[c.id]) {
                            this.conns[c.id].send({ type: 'group-invite', groupName: document.getElementById('current-chat-name').innerText, groupId: this.state.activeChatId, senderId: this.myId });
                            showToast("Sent");
                        }
                    };
                    l.appendChild(b);
                });
                document.getElementById('modal-invite-contact').classList.remove('hidden');
            }
            exportData() { 
                const d = { user: this.state.user, groups: this.state.groups, contacts: this.state.contacts };
                if(document.getElementById('include-history-check').checked) d.chats = this.state.chats;
                const s = JSON.stringify(d);
                document.getElementById('import-area').value = s;
                navigator.clipboard.writeText(s);
                showToast("Data Copied");
            }
            importData() {
                try {
                    const d = JSON.parse(document.getElementById('import-area').value);
                    if(d.user) localStorage.setItem('cozyUser', JSON.stringify(d.user));
                    if(d.groups) localStorage.setItem('cozyGroups', JSON.stringify(d.groups));
                    if(d.chats) localStorage.setItem('cozyChats', JSON.stringify(d.chats));
                    location.reload();
                } catch(e) { showToast("Invalid Data"); }
            }
            resetProfile() { if(confirm("Clear all data?")) { localStorage.clear(); location.reload(); } }
            joinGroupById() {
                const id = document.getElementById('join-group-input').value.trim();
                if(!id) return;
                showToast("Connecting...");
                this.addContact(id);
            }
            acceptGroupInvite() {
                 document.getElementById('modal-join-request').classList.add('hidden');
            }
            shareScreen() {
                 navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }).then(stream => {
                     this.engine.applyVideoTexture(stream);
                     this.engine.handleIncomingStream(stream, this.myId);
                     Object.values(this.conns).forEach(c => this.peer.call(c.peer, stream));
                 });
            }
            openStreamModal() { document.getElementById('modal-stream').classList.remove('hidden'); const v = document.getElementById('stream-video'); v.muted = false; }
            closeStreamModal() { document.getElementById('modal-stream').classList.add('hidden'); }
            toggleStreamMute() { const v = document.getElementById('stream-video'); v.muted = !v.muted; document.getElementById('btn-stream-mute').innerHTML = v.muted ? '<i class="ph ph-speaker-slash text-white"></i>' : '<i class="ph ph-speaker-high text-white"></i>'; }
            toggleCameraMode() { this.engine.toggleCamera(); }
        }

        window.onload = () => window.app = new App();
    </script>
</body>
</html>
